let songInfo = {
    "artists":{
        "Adele":{
            "avatarImage":{
                "url":"https://images.genius.com/638bddc79cd2ada6404099b0f2ac70a3.1000x1000x1.jpg"
            },
            "albums":{
                "21":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                            "Fire to the rain"
                        ]
                }
            }
        },
        "Ali Gatie":{
            "avatarImage":{
                "url":"https://images.genius.com/f59533799cad2b07bb29869ee6339076.640x640x1.jpg"
            },
            "albums":{
                "YOU":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                        "Idk",
                        "Its you"
                    ]
                }
            }
            },
        "Arizona Zervas":{
            "avatarImage":{
                "url":"https://images.genius.com/409e8e46e8e9b3ab949f00139f7c3935.1000x1000x1.jpg"
            },
            "albums":{
                "Living Facts":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                        "24",
                        "C u l8r",
                        "Drain me",
                        "FML",
                        "My time",
                        "On ten",
                        "Oh my lord",
                        "Holy trinity"
                    ]
                }
            }
        },
        "Bring Me The Horizon":{
            "avatarImage":{
                "url":"https://images.genius.com/64c7d35c8d427522574cbf7773084ee3.1000x1000x1.jpg"
            },
            "albums":{
                "TempAlbumName":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                        "Can you feel my heart",
                        "Die4u",
                        "Sleepwalking",
                        "Throne",
                        "Teardops"
                    ]
                }
            }
        },
        "Bruno Mars":{
            "avatarImage":{
                "url":"https://images.genius.com/ec38c902389e5d9df5782aa54fcf3c00.888x888x1.jpg"
            },
            "albums":{
                "Unorthodox Jukebox":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                        "Treasure"
                    ]
                }
            }
        },
        "Charlie Puth":{
            "avatarImage":{
                "url":"https://images.genius.com/6fe8a772b486b738d715082cba404165.320x320x1.jpg"
            },
            "albums":{
                "Voicenotes":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                        "Attention",
                        "How long",
                        "Thats hilarious"
                        ]
                },
                "Nine Track Mind":{
                    "cover":{
                        "url":"somelink"
                    },
                    "songs":[
                        "One call away",
                        "We dont talk anymore"
                        ]
                }
            }
        },
        "Chase Atlantic":{
            "avatarImage":{
                "url":"https://images.genius.com/dbf3b86bc9c5086da7afd7544a6a0a14.1000x1000x1.jpg"
            },
            "albums":{
                "Chase Atlantic":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Angeline",
                        "Consume",
                        "Into it",
                        "Numb to the feeling",
                        "Okay",
                        "Ozone",
                        "STUCKINMYBRAIN",
                        "Swim",
                        "the walls",
                        "Uncomforable"
                    ]
                }
            }
        },
        "Dababy":{
            "avatarImage":{
                "url":"https://images.genius.com/b68b0e6ba289b80529dc0194cdb7d00d.639x640x1.jpg"
            },
            "albums":{
                "BLAME IT ON BABY":[
                    "Rockstar"
                ]
            }
        },
        "DJ Khaled":{
            "avatarImage":{
                "url":"https://images.genius.com/ab6d177ad39383915733cf37ca1fb301.999x999x1.jpg"
            },
            "albums":{
                "KHALED KHALED":[
                    "Greece",
                    "I did it"
                ]
            }   
        },
        "Dominic Fike":{
            "avatarImage":{
                "url":"https://images.genius.com/d423af243f7f92d2181274c9f6da612d.1000x1000x1.jpg"
            },
            "albums":{
                "Dont Forget About Me Demos":[
                    "Phone Numbers",
                    "3 Nights"
                ]
            }
        },
        "Drake":{
            "avatarImage":{
                "url":"https://images.genius.com/631b206379b60df5e1da90e84d35fdbe.1000x1000x1.png"
            },
            "albums":{
                "Views":{
                    "cover":{"url":"https://bit.ly/3Bl7maq"},
                    "songs":[
                        "Fair trade",
                        "Fire desire",
                        "In my feelings",
                        "Feel no ways",
                        "Hotline bling",
                        "One dance",
                        "Race my mind"
                    ]
                },
                "Take Care":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Doing it wrong"
                    ]
                },
                "More Life":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Passionfruit"
                    ]
                },
                "Nothing was the same":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Hold on were going home"
                    ]
                },
                "Dark Lane Demo Tapes":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Pain 1993"
                    ]
                },
                "Lil Durk":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Laugh now cry later"
                    ]
                }
            }
        },
        "Ed Sheeran":{
            "avatarImage":{
                "url":"https://images.genius.com/b501daeff73d1b17610f47a5668f690a.1000x1000x1.jpg"
            },
            "albums":{
                "Divide":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Happier",
                        "Perfect",
                        "Shape of you"
                    ]
                },
                "Multiply":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Thinking out loud"
                    ]
                },
                "Equals":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Shivers"
                    ]
                }
            }
        },
        "J. Cole":{
            "avatarImage":{
                "url":"https://images.genius.com/84a98a8d26b13b7311aa2359ebade757.1000x1000x1.jpg"
            },
            "albums":{
                "Forest Hills Drive":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "Intro",
                        "January 28th",
                        "Wet Dreamz",
                        "A Tale of 2 Citiez",
                        "Fire Squad",
                        "St Tropez",
                        "G.O.M.D.",
                        "No Role Modelz"
                    ]
                }
            }
            
        },
        "The Kid LAROI":{
            "avatarImage":{
                "url":"https://images.genius.com/b4902c54d7d33d0c7d43171894b7762a.660x660x1.jpg"
            },
            "albums":{
                "Fuck Love":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "WITHOUT YOU"
                    ]
                }
            }
        },
        "Roddy Ricch":{
            "avatarImage":{
                "url":"https://images.genius.com/ec507fd0e7f60ce3345349981fbcf0a0.1000x1000x1.jpg"
            },
            "albums":{
                "Please Excuse Me For Being Antisocial":{
                    "cover":{"url":"somelink"},
                    "songs":[
                        "High Fashion"
                    ]
                }
            }
        }
    }
}


let currentsonginfoTemplate = {
    "title": "",
    "author": "",
    "album": "",
    "titlecover":"https://bit.ly/3p239kI",
    "albumcover":"https://bit.ly/3p239kI",
    "authorimage":"https://bit.ly/3p239kI",
    "timestamp":'0',
    "isPlaying": false,
    "index": 0,
    "volume":1
}

if(ls.getItem('currentSongInfo')== null){
    ls.setItem("currentSongInfo", JSON.stringify(currentsonginfoTemplate));
}
////////////////////////////////////////////////////////////// un-comment this next line to reset the currentsonginfo cookie
// ls.setItem("currentSongInfo", JSON.stringify(currentsonginfoTemplate))

let head = document.querySelector('head');
let songplaying = document.querySelector(".currentplaying");
let title = document.querySelector('.title-name');
let author = document.querySelector('.author-name');
let playpausebtn = document.querySelector('.ppbtn');
let playnext = document.querySelector('.play-forward');
let playprevious = document.querySelector('.play-back');
let slider = document.querySelector(".slider");
let volumebtn = document.querySelector('.volume');
let volumeSlider = document.querySelector('.volume-slider');
let made4u_list = document.querySelector('.madeforyou');
let song_image_label = document.querySelector('.song-img')
const play = document.getElementsByClassName('.playbtn');

// Iterate over play buttons and create an event for each one 

for(artist in songInfo['artists']){
    var playlist = document.createElement("div");
    playlist.classList.add('playlist');
    playlist.innerHTML = '<div><img src="'+songInfo["artists"][artist]["avatarImage"]["url"]+'" alt=""><p class="playlist-title">'+artist+' Mix</p><p class="playlist-artists">'+artist+'</p><div class="playbtn" value="'+artist+'" onclick="playArtist(\''+artist+'\')"><ion-icon name="play"></ion-icon></div></div>'
    made4u_list.appendChild(playlist);
};

playpausebtn.addEventListener("click", resumesong);
playnext.addEventListener("click", ()=>{
    next_previous(1);
});
playprevious.addEventListener('click', ()=>{
    next_previous(2);
});

//______________________/This bit still needs work\__________________________
for(i=0;i<play.length;i++){
    var btn = play[i];
    btn.addEventListener('click',function(){
        playArtist(btn.getAttribute('value'));
    })
}
//____________________________/end of that bit\______________________________|

window.onload = load;
window.onunload = unload;

function changeSongTime(){
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    songplaying.pause();
    var p = slider.value;
    var d = songplaying.duration;
    var ct = (p/100)*d;
    songplaying.currentTime = ct;
    info.timestamp = ct;
    songplaying.play();
    ls.setItem("currentSongInfo", JSON.stringify(info));
    playpausebtn.innerHTML = '<ion-icon name="pause-outline"></ion-icon>';
}
function updateSlider(){
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    getTime(songplaying);
    var d = songplaying.duration;
    var ct = songplaying.currentTime;
    var p = (ct/d)*100
    slider.value = p;
    info.timestamp = ct;
    ls.setItem("currentSongInfo", JSON.stringify(info));
}
songplaying.addEventListener("timeupdate", function(){
    setInterval(updateSlider, 500);
});
slider.addEventListener('change', changeSongTime)
slider.addEventListener('mousedown', ()=>{
    printf("mousedown")
    changeSongTime;
    songplaying.pause();
})
slider.addEventListener("mouseup", ()=>{
    printf("mouseup")
    changeSongTime;
    songplaying.play()
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    info.isPlaying = false;
    ls.setItem("currentSongInfo", JSON.stringify(info));
})

// Get infos when the page load
function load(){
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    var artistV = info.author;
    var albumV = info.album;
    var titleV = info.title;
    var timestamp = info.timestamp;
    title.innerHTML = titleV;
    author.innerHTML = artistV;
    song_image_label.src = info.titlecover;
    artistV = replace(artistV, ' ', '%20');
    albumV = replace(albumV, ' ', '%20');
    titleV = replace(titleV, ' ', "%20");
    var dir = "https://swirx.github.io/SX-Waves-Songs/"+artistV+"/"+albumV+"/"+titleV+".mp3";
    songplaying.src = dir;
    songplaying.currentTime = timestamp;
    getTime(songplaying);
};
//Get current song/album/artist 's images

function setInfo(title, artist){

    var artistName = artist;
    var titleName = title;
    var formated_AN = replace(artistName, " ", "%20");
    var formated_TN = replace(titleName, " ", "%20");
    var formatedSearch = formated_AN+"%20"+formated_TN;
    const xhr = new XMLHttpRequest();
    xhr.withCredentials = false;

    xhr.addEventListener("readystatechange", function () {
        if (this.readyState === this.DONE) {
            var response = JSON.parse(xhr.responseText);
            response = response['response'];
            printf(response)
            var song_info = response["hits"][0]["result"];
            var albumCover = song_info["header_image_thumbnail_url"];
            var songCover = song_info["song_art_image_thumbnail_url"];
            var artistImage = song_info["primary_artist"]["image_url"];
            
            var info = JSON.parse(ls.getItem("currentSongInfo"));
            info.titlecover = songCover;
            info.albumcover = albumCover;
            info.authorimage = artistImage;
            ls.setItem("currentSongInfo", JSON.stringify(info));
                    
            song_image_label.src = info.titlecover;
        }
    });

    xhr.open("GET", "https://genius.p.rapidapi.com/search?q="+formatedSearch);
    xhr.setRequestHeader("X-RapidAPI-Key", "31fe39f73cmsh36dfb1ec4200a2cp1e3562jsn45979521f11b");
    xhr.setRequestHeader("X-RapidAPI-Host", "genius.p.rapidapi.com");

    xhr.send();
}

function getInfo(artist = new String(), title=""){

    var formatedSearch = artist+"%20"+title;
    const xhr = new XMLHttpRequest();
    xhr.withCredentials = false;
    
    xhr.addEventListener('readystatechange',function(){
        if(this.readyState === this.DONE){
            var response = JSON.parse(xhr.responseText);
            response = response['response'];
            var song_info = response["hits"][0]["result"];
            var albumCover = song_info["header_image_thumbnail_url"];
            var songCover = song_info["song_art_image_thumbnail_url"];
            var artistImage = song_info["primary_artist"]["image_url"];
            printf(artistImage)
            // get the song info object 
            songInfo["artists"][artist]["avatarImage"]["url"] = artistImage;
    }})

    xhr.open("GET", "https://genius.p.rapidapi.com/search?q="+formatedSearch);
    xhr.setRequestHeader("X-RapidAPI-Key", "31fe39f73cmsh36dfb1ec4200a2cp1e3562jsn45979521f11b");
    xhr.setRequestHeader("X-RapidAPI-Host", "genius.p.rapidapi.com");
    xhr.send();
}

// Save the info when the page closes
function unload(){
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    var timestamp = info.timestamp;
    timestamp = songplaying.currentTime;
    ls.setItem("currentSongInfo", JSON.stringify(info));
};
// play/pause 
function resumesong(){
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    if(info.isPlaying==true){
        songplaying.currentTime=info.timestamp;
        songplaying.pause();
        playpausebtn.innerHTML = '<ion-icon name="play-outline"></ion-icon>';
        info.isPlaying = false;
    }else{
        songplaying.play();
        playpausebtn.innerHTML = '<ion-icon name="pause-outline"></ion-icon>';
        info.isPlaying = true;
    }
    ls.setItem("currentSongInfo", JSON.stringify(info));
};

// volume
volumebtn.addEventListener('click', ()=>{
    printf('clicked')
    volumeSlider.classList.toggle("hidden");
})
volumeSlider.addEventListener('change', volume);

function volume(){
    info = JSON.parse(ls.getItem("currentSongInfo"));
    var value = slider.value;
    var newVolume = value/100;
    songplaying.volume = newVolume;
    info.volume = newVolume;
    ls.setItem("currentSongInfo", JSON.stringify(info));
};

// update the info 
function updateInfo(a_n, al_n, s_n, ts, p, i){
    info = JSON.parse(ls.getItem("currentSongInfo"));
    info.author = a_n;
    info.album = al_n;
    info.title = s_n;
    info.timestamp = ts; 
    info.isPlaying = p;
    info.index = i;
    ls.setItem("currentSongInfo", JSON.stringify(info));
};

// next/previous
function next_previous(v){
    if(v==1){
        var info = JSON.parse(ls.getItem("currentSongInfo"));
        var cArtist = info.author;
        var cAlbum = info.album;
        var newIndex = info.index;
        var currentArtist = songInfo["artists"][cArtist];
        var currentAlbum = currentArtist["albums"][cAlbum];
        if(newIndex>=((currentAlbum["songs"].length)-1)){
            newIndex=0
        }else{
            newIndex++
        };
        playAlbum(cArtist, cAlbum, newIndex);
    }else{
        var info = JSON.parse(ls.getItem("currentSongInfo"));
        var cArtist = info.author;
        var cAlbum = info.album;
        var newIndex = info.index;
        var currentArtist = songInfo["artists"][cArtist];
        var currentAlbum = currentArtist["albums"][cAlbum];
        if(songplaying.currentTime<3){
            if(newIndex!=0){
                newIndex--
            }else{
                newIndex=(currentAlbum["songs"].length)-1
            };
        }else{
            songplaying.pause();
            songplaying.currentTime = 0;
            songplaying.play()
        }
        playAlbum(cArtist, cAlbum, newIndex);
    };
};

// Play an aux 
function playsong(artist_name, album_name,song_name, i){
    setInfo(song_name, artist_name);
    var info = JSON.parse(ls.getItem("currentSongInfo"));
    var playing = info.isPlaying;
    var dir = "https://swirx.github.io/SX-Waves-Songs/"+replace(artist_name, ' ', '%20')+"/"+replace(album_name, ' ', '%20')+"/"+replace(song_name, ' ', "%20")+".mp3";
    songplaying.src = dir;
    if(!playing){
        title.innerHTML = song_name;
        author.innerHTML = artist_name;
        songplaying.play();
        playpausebtn.innerHTML = '<ion-icon name="pause-outline"></ion-icon>';
    }else{
        title.innerHTML = song_name;
        author.innerHTML = artist_name;
        songplaying.play();
        playpausebtn.innerHTML = '<ion-icon name="pause-outline"></ion-icon>';
    };
    updateInfo(artist_name, album_name, song_name, 0, true, i);
};


// play an album (old)
function playAlbum(artistName, albumName, i, artistplay=null, album_index=null){
    printf("playAlbum function started")
    var currentArtist = songInfo["artists"][artistName];
    var currentAlbum = currentArtist["albums"][albumName];
    playsong(artistName, albumName, currentAlbum["songs"][i], i);
    songplaying.addEventListener("ended", function(){
        printf("song ended");
        if(i<currentAlbum["songs"].length){
            i++;
            playsong(artistName, albumName, currentAlbum["songs"][i], i);
        }else{
            if (artistplay==null) {
            i=0;
            playsong(artistName, albumName, currentAlbum["songs"][i], i);
            }else{
                album_index++;
                playArtist(artistName, album_index);
            }
        }
    });
};
// (new)


// play an artist's songs
function playArtist(artist, index=0){
    printf("playArtist function started");
    var artistJSON = songInfo['artists'][artist];
    var albums = new Array()
    for (var album in artistJSON["albums"]){
        albums.push(album);
    }
    playAlbum(artist, albums[index], 0, true, index);
}

// get the audios's current time
function getTime(s_obj) {
    var duration = document.querySelector('.duration');
    var s = parseInt(s_obj.currentTime % 60);
    var m = parseInt((s_obj.currentTime / 60) % 60);
    if(s<10){
        s= "0"+s;
    };
     duration.innerHTML = m + ':' + s ;
};